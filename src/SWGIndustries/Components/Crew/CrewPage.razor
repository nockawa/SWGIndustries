@page "/Crew"
@using SWGIndustries.Data
@using SWGIndustries.Services

@inject ISnackbar Snackbar
@inject DataAccessService DataAccessService


<!-- Display the crew leader pane if the user is a crew leader -->
@switch (_crewType)
{
    case CrewType.Leader:
    {
        <h3>Crew leader home</h3>
        <CrewLeaderPane Crew="_crew"/>
        break;
    }

    case CrewType.Member:
    {
        <h3>Crew member home</h3>
        if (_answeredCrewRequest != null)
        {
            <MudAlert Class="ma-4 pa-4" Severity="Severity.Success" ContentAlignment="HorizontalAlignment.Left" ShowCloseIcon="true" 
                      CloseIconClicked="async () => await CloseAnsweredCrewRequest()">
                @($"Crew leader {_answeredCrewRequest.ToUser.Name} has granted your request to join the crew {_answeredCrewRequest.FromUser.Crew.Name}.")
            </MudAlert>
        }
        break;
    }

    case CrewType.NotInCrew:
    {
        if (_answeredCrewRequest != null)
        {
            <MudAlert Class="ma-4 pa-4" Severity="Severity.Error" ContentAlignment="HorizontalAlignment.Left" ShowCloseIcon="true" 
                      CloseIconClicked="async () => await CloseAnsweredCrewRequest()">
                @($"Crew leader {_answeredCrewRequest.ToUser.Name} has rejected your request.")
            </MudAlert>
        }

        // Display pending request, if any
        if (_pendingCrewRequests!=null && _pendingCrewRequests.Count>0)
        {
            <MemberPendingCrewRequests PendingRequests="_pendingCrewRequests" 
                                       OnDeleteSentInvitationRequest="@(async void (invitation) => await DeleteSentInvitationRequest(invitation))"
                                       OnRequestToJoinCrew="@(async void (invitation, grandOrDeny) => await ProcessRequestToJoinCrew(invitation, grandOrDeny))"/>
        }

        <!-- Display the forms to create or join a crew -->
        <CreateOrJoinCrew 
            Crew="_crew" 
            HasAnyRequests="@((_pendingCrewRequests!=null && _pendingCrewRequests.Any()) || _answeredCrewRequest != null)"
            OnRequestToJoinCrew="@(async void (_) => { await UpdateCrewState(); })"
            OnCrewCreated="@(async void (crew) => { _crew = crew; await UpdateCrewState(); })" />
        
        break;
    }
}

@code {

    private enum CrewType
    {
        NotInCrew,
        Member,
        Leader
    }
    
    private ApplicationUser _applicationUser;
    private CrewType _crewType;
    private Crew _crew;
    
    private IList<CrewInvitation> _pendingCrewRequests;
    private CrewInvitation _answeredCrewRequest;

    protected override async Task OnInitializedAsync()
    {
        _applicationUser = await DataAccessService.GetApplicationUserAsync();
        await DataAccessService.DbContext.Entry(_applicationUser).Reference(a => a.Crew).LoadAsync();
        _crew = _applicationUser.Crew;
        await UpdateCrewState();
    }

    private async Task UpdateCrewState()
    {
        _pendingCrewRequests = await DataAccessService.GetPendingCrewRequests(_applicationUser);
        _answeredCrewRequest = await DataAccessService.GetAnsweredCrewRequest();
        if (_crew == null)
        {
            _crewType = CrewType.NotInCrew;
        }
        else if (_crew.CrewLeader == _applicationUser)
        {
            _crewType = CrewType.Leader;
        }
        else
        {
            _crewType = CrewType.Member;
        }
        StateHasChanged();
    }
    
    private async Task DeleteSentInvitationRequest(CrewInvitation invitation)
    {
        if (await DataAccessService.DeleteCrewInvitation(invitation))
        {
            Snackbar.Add("Request deleted.", Severity.Success);
            await UpdateCrewState();
        }
        else
        {
            Snackbar.Add($"Failed to delete request.", Severity.Error);
        }        
    }

    private async Task ProcessRequestToJoinCrew(CrewInvitation invitation, bool grantOrDeny)
    {
        var (res, info) = await DataAccessService.ProcessInvitationToJoinCrew(invitation, grantOrDeny);
        if (res)
        {
            Snackbar.Add(info, Severity.Success);
            await UpdateCrewState();
        }
        else
        {
            Snackbar.Add(info, Severity.Error);
        }
    }

    private async Task CloseAnsweredCrewRequest()
    {
        await DataAccessService.CloseCrewInvitation(_answeredCrewRequest);
        await UpdateCrewState();
    }
}